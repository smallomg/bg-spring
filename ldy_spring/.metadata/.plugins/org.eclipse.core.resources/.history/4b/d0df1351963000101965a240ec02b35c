package com.example.demo.restcontroller;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;

import com.example.demo.dto.MemberDTO;

import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@RestController
public class RandomController {

    @PostMapping("/random")
    public String random(@RequestBody Map<String, Object> payload, HttpServletRequest request) {
        HttpSession session = request.getSession();
        MemberDTO member = (MemberDTO) session.getAttribute("member");

        if (member == null) {
            return "ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.";
        }

        String userId = member.getId(); // íšŒì› ID ê¸°ì¤€
        Map<String, Integer> tryMap = (Map<String, Integer>) session.getAttribute("tryMap");
        if (tryMap == null) {
            tryMap = new HashMap<>();
            session.setAttribute("tryMap", tryMap);
        }

        int currentTry = tryMap.getOrDefault(userId, 0);
        if (currentTry >= 3) {
            return "âŒ 3ë²ˆì˜ ê¸°íšŒë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!";
        }

        tryMap.put(userId, currentTry + 1);

        // ìœ ì € ëœë¤ ìˆ˜
        int userNum = Integer.parseInt(payload.get("num").toString());
        // ì»´í“¨í„° ëœë¤ ìˆ˜
        int compNum = (int)(Math.random() * 10 + 1);

        if (userNum == compNum) {
            tryMap.put(userId, 3); // ë§ì¶”ë©´ ë°”ë¡œ ëë‚´ê¸°
            return "ğŸ‰ ìŠ¹ë¦¬! (ìœ ì €: " + userNum + ", ì»´í“¨í„°: " + compNum + ")";
        } else {
            return "ğŸ˜¢ ì‹¤íŒ¨! (ìœ ì €: " + userNum + ", ì»´í“¨í„°: " + compNum + ") | ë‚¨ì€ ê¸°íšŒ: " + (2 - currentTry);
        }
    }
}
