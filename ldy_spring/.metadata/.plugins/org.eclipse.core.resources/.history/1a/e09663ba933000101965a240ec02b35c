package com.example.demo.restcontroller;

import java.util.HashMap;
import java.util.Map;

import jakarta.servlet.http.HttpSession;
import org.springframework.web.bind.annotation.*;

@RestController
public class GameController {

    @PostMapping("/check-number")
    public String checkNumber(@RequestBody Map<String, Object> payload, HttpSession session) {
        String userId = (String) session.getAttribute("loginId"); // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
        if (userId == null) return "ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.";

        int guess = Integer.parseInt(payload.get("guess").toString());

        // ì„¸ì…˜ì— ì €ì¥ëœ ì •ë‹µ ìˆ«ì ì—†ìœ¼ë©´ ìƒì„±
        Integer answer = (Integer) session.getAttribute("answer");
        if (answer == null) {
            answer = (int)(Math.random() * 10 + 1);
            session.setAttribute("answer", answer);
        }

        // ì‹œë„ íšŸìˆ˜ Map
        Map<String, Integer> tryMap = (Map<String, Integer>) session.getAttribute("tryMap");
        if (tryMap == null) {
            tryMap = new HashMap<>();
            session.setAttribute("tryMap", tryMap);
        }

        int currentTry = tryMap.getOrDefault(userId, 0);
        if (currentTry >= 3) {
            return "âŒ ì‹œë„ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤. (ìµœëŒ€ 3íšŒ)";
        }

        tryMap.put(userId, currentTry + 1);

        if (guess == answer) {
            session.removeAttribute("answer");         // ì •ë‹µ ë¦¬ì…‹
            tryMap.put(userId, 0);                      // ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
            return "ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!";
        } else {
            return "âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‚¨ì€ ì‹œë„ íšŸìˆ˜: " + (2 - currentTry);
        }
    }
}